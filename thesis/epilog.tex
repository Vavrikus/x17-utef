\chapwithtoc{Conclusion}
	We have developed and implemented several methods for the reconstruction of electron and positron trajectories inside the Orthogonal Fields Time Projection Chambers (\acp{OFTPC}) that will be used in the X17 project at the \acf{IEAPCTU} to confirm or disprove the ATOMKI anomaly~\cite{atomki_be}. We tested these methods on simulated tracks and made a~preliminary estimate of the achievable energy resolution.
	
	We used the \garfieldpp toolkit~\cite{Garfield++} for simulations in combination with the ROOT~framework~\cite{ROOT} for data analysis and visualization. Some of our more demanding simulations were run on the MetaCentrum grid~\cite{metacentrum}. The main method of track simulation was the microscopic simulation (provided by the \texttt{Avalanche\-Microscopic} class), which follows ionization electrons from collision to collision.
	
	\subsubsection*{Track Reconstruction}
		The inhomogeneous magnetic field created by permanent magnets is perpendicular to the electric field of the chambers and has a~significant effect on the drift of ionization electrons (as demonstrated in \cref{sec:rasd}). For this reason, we created the ionization electron map, i.e., a~mapping from the detector space~$\mathcal{D}$ (coordinates $(x,y,z)$), where the initial positions of ionization electrons lie, to the readout space~$\mathcal{R}$ (coordinates $(x',y',t)$), where their endpoints on the readout plane lie. The map was simulated using the microscopic simulation. One hundred electrons with low initial velocity were simulated for each point on a~Cartesian grid to get their mean readout coordinates and their covariance. Two gas mixtures 90:10 and 70:30 Ar:CO$_2$ were compared. In the former, the drift velocity is significantly higher, leading to an increased effect of the magnetic field and larger diffusion (see, for example, \cref{fig:map_yx_bot}).
		
		To use the map in reconstruction, we have to invert it. We implemented two methods -- a~gradient descent algorithm that finds a~minimum in the trilinearly interpolated map, and a~polynomial interpolation on the inverse grid in the readout space (where we know the inverse from the simulation). Both methods reach almost identical results for the testing track, while the latter is much faster, does not require optimization of parameters, and can be accelerated by precalculating the interpolation coefficients in the future if needed. The reconstruction was shown to be accurate with less than \qty{2}{\mm} \acs{FWHM}, although a~slight shift in the $z$\nobreakdash-coordinate was detected when accounting for different initial velocities of the ionization electrons (see \cref{fig:9010_map_res,fig:7030_map_res}).
		
		The discrete reconstruction takes into account the anode segmentation into pads and the finite size of the time bins. It neglects the gaps between the pads and assumes an ideal readout of charge, counting each individual electron hitting the pad. Charge multiplication in the triple-\ac{GEM} stack used in the \ac{OFTPC} is not taken into account. For each pad/time-bin combination, we use the map inversion to reconstruct its center. Reconstruction of detector coordinates corresponding to electrons hitting pad 12 near the magnet pole (\cref{fig:pad_reco,fig:pad_reco_old}) shows that interpolation on the inverse grid behaves pathologically for large distortions, unlike the much slower gradient descent algorithm, likely because of large coefficients of the quadratic and cubic terms.
		
	\subsubsection*{Energy Reconstruction}
		To reconstruct the energy of a~particle in a~\ac{OFTPC}, we assess its curvature in the inhomogeneous magnetic field. Preliminary tests were done using tracks reconstructed with the map with no discretization. At first, we tested a~cubic spline fit, where the radius of curvature can be determined analytically. This approach turned out to be unpractical because of relatively low speed, and the necessity to create the energy estimate from the radius and magnetic field at different points on the track (see \cref{fig:spline}).
		
		Another tested approach (at first as a~2D version without pads, later in 3D with pads) was the fit with a~circular arc with smoothly attached lines, which is the shape of trajectory of a~particle crossing a~finite volume with homogeneous magnetic field oriented perpendicularly to the particle's velocity vector. This way we get a~single reconstructed radius of curvature, however, since the magnetic field varies greatly along the track inside the \ac{OFTPC} volume, it is not clear, which value of magnetic field to use to calculate the energy. Two simple estimates were implemented:
		\begin{enumerate}[nosep]
			\item using the value at the point, where the track crosses the middle $x$\nobreakdash-coordinate and
			\item using the average value along the circular arc in the fit,
		\end{enumerate}
		in both cases, only the component perpendicular to the plane of the fit is considered. The three-dimensional version of the fit has four free parameters (radius, length of the first line, length of the circular arc, and rotation angle around the first line). In order for the fit to converge correctly in all cases, the parameter bounds have to be set carefully. Disallowing pathological values that are not expected for any real track may cause the MIGRAD algorithm to converge at the bound. The fit was successfully tested on a~sample of Runge-Kutta tracks described in \cref{sec:rktest}; the results in \cref{fig:cfit_rk} show that the average field estimate systematically underestimates the energy of the track, but its \acs{FWHM} is much smaller than that of the middle field estimate.
		
		The best developed method was the Runge-Kutta fit. In a~simplified model, we assume that the previous layers of detectors will provide us with exact initial position and direction of the particle, when entering the \ac{OFTPC}. We can then use 4th\nobreakdash-order Runge-Kutta numerical integration to simulate such a~trajectory for different energies. In order to speed up the fit and ensure convergence of the fit, we use a~corrected estimate from the circle-and-lines fit with average field as a~starting point. We tested this method on a~grid-like sample of microscopic tracks, described in \cref{sec:microgrid}, fitting tracks reconstructed with the discrete map inversion. As shown in \cref{fig:rk_dE}, we can reach energy resolution (\acs{FWHM}) \qty{1.56}{\percent} for electrons (which curve away from the readout, enabling charge spreading across multiple channels) and \qty{1.95}{\percent} for positrons without correcting systematic errors dependent on the track parameters, assuming an ideal charge readout with no noise and no amplification.
		
		The code used in this thesis, and in related work, is available publicly at \url{https://github.com/Vavrikus/x17-utef}.
	\section*{Future}
	\addcontentsline{toc}{section}{Future}
		In order to develop a~functioning algorithm for the real detector, there are still many things left to account for. Here are some examples of what steps can or will be taken next.
		
	\subsubsection*{Simulations}
		There are several important factors that need to be considered when simulating the detector response:
		\begin{itemize}
			\item Charge multiplication on the triple-\ac{GEM} and limited efficiency of the readout. In some cases, the spreading of charge between multiple pads during multiplication might have a~positive effect on the resolution.
			\item Noise in the data. We are currently tuning an algorithm for track de-noising using a~convolutional neural network~\cite{Gajdo≈°_2025}.
			\item Delta electrons released by the particle.
			\item Electron attachment and Penning transfer in the gas mixture. Influence of even small amounts of other gases needs to be considered.
			\item Energy loss of the primary electrons and positrons.
			\item Better simulation of magnetic and electric fields; so far we have been assuming that the electric field is homogeneous. A~simulation of the triple~\ac{GEM} could be included, but some simplifications would be necessary, since the microscopic simulation needed for such a~structure is extremely time-consuming.
			\item Account for the triggering in \ac{MWPC} and \acf{TPX3} detector layers. While a~small uncertainty of the drift time measurement may not be relevant for the energy reconstruction in a~standard \ac{TPC} with a~homogeneous magnetic field, a~shift of the entire trajectory along the $z$\nobreakdash-coordinate in our detector changes the magnetic field along the track, and therefore the reconstructed energy.
			\item An optimization study of the pad layout is possible with the current algorithm.
		\end{itemize}
		It might be also useful to use a~faster simulation method for more robust reconstruction testing. Currently, a~simple Monte Carlo simulation, using the covariance matrices from the map simulation, is implemented and can be used along with \ac{HEED} to simulate tracks similar to the microscopic ones. The microscopic simulation is very time-consuming, we have already spent \num{25165.6} CPU days during the simulation of the grid-like testing sample, and partly during the map simulation.
		
	\subsubsection*{Experimental calibration}
		To achieve the best results, the reconstruction needs to be calibrated using measurements from the real detector. This includes:
		\begin{itemize}
			\item measurement of the magnetic field of the permanent magnets,
			\item reconstruction of straight tracks from laser or muons, and
			\item reconstruction of electrons with known energy distribution, if possible.
		\end{itemize}
		
	\subsubsection*{Reconstruction algorithm}
		Several tweaks are being considered to improve the reconstruction algorithm in the future:
		\begin{itemize}
			\item Optimization --- multiple Runge-Kutta fits could be run with gradually decreasing step size.
			\item Estimation of errors using the error of the fit.
			\item Accounting for the variable initial velocity of ionization electrons produced by the incident particle. The current map uses initial energy \qty{0.1}{\eV}, which led to systematic errors in the $z$\nobreakdash-coordinate reconstruction, as shown in \cref{fig:7030_map_res}. Another map could be simulated with different initial direction and energy distributions, tracking the ionization electrons only until they slow down to the mean drift velocity, and using the already simulated map from there. Alternatively, we could correct the reconstructed $z$\nobreakdash-coordinate based on the reconstructed curve of the track using some rough estimate obtained from a~grid-like simulation of microscopic tracks.
			\item If a~speed optimization is needed, a~discrete pad map could be calculated ahead of time, instead of repeated calculation during the reconstruction. At this moment, the most computationally expensive part of the reconstruction is the individual fits. The slower gradient descent map inversion technique may be used to avoid issues with the interpolation on the inverse grid (shown in \cref{fig:pad_reco}).
			\item At the end of the fitting procedure, we could refine the origin and the initial direction of the track obtained from the previous detector layers with some kind of global fit.
			\item Using maximum likelihood for the energy fit, instead of the least squares method. Currently, in the discrete map inversion reconstruction, we reconstruct the center of each hit pad and time bin. However, due to the drift distortion, this may not correspond to the most likely, or even the average position to be hit by an ionization electron.
			
			In theory, we could by taking into account the whole map $\mathcal{M}$ (including the covariance matrices, describing the multivariate normal distribution that describes each map point well according to our preliminary tests), we could make an "inverse map" from $\mathcal{R}$ to distributions on $\mathcal{D}$. We could achieve this by taking the normalized probability density of an electron with initial coordinates $(x,y,z)$ having readout coordinates $(x',y',t)$. If we fix $(x',y',t)$, we get an unnormalized probability density $f(x,y,z) = \mathcal{M}_{(x,y,z)}(x',y',t)$ (assuming that all initial coordinates are a~priori equally likely). This could potentially improve the discrete reconstruction if we take the mean value of this probability density across the pad and time bin
			\begin{equation}
				f_\text{pad, bin}(x,y,z) = \frac{1}{A_\text{pad} \Delta t_\text{bin}} \int_\text{pad, bin} \mathcal{M}_{(x,y,z)}(x',y',t) 	\text{d}x'\text{d}y'\text{d}t
			\end{equation}
			and using it for a~likelihood fit instead of using least squares. This still assumes that all initial coordinates are equally likely which is clearly not the case for a~primary particle track. In the future, we could even use the fast track simulation with the map (it should be possible to make around 1000 tracks or more per minute per core with current settings), create a~big set of tracks with reasonable parameters and use these to get an approximation of the probability distribution of the detector response. Some approximations would be necessary when interpreting the data to decrease the degrees of freedom of this distribution (we would have to pick a~set of parameters and assume that some of them are independent). This could give us an idea about the best achievable resolution (how significantly will the detector response differ for a~given change in energy). If the difference is significant, we could try to further improve the likelihood fit.
		\end{itemize}